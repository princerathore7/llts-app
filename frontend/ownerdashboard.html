<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Owner Dashboard</title>
  <link rel="stylesheet" href="lltsstyle.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
  body {
  background: radial-gradient(circle at top left, #1a1a2e, #16213e, #0f3460);
  color: #fefefe;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}

.owner-dashboard {
  padding: 2rem 1rem;
  text-align: center;
  position: relative;
}

header h1 {
  font-size: 3.2rem;
  color: #ffd700;
  text-shadow: 2px 2px 10px #000;
  animation: glow-text 2s ease-in-out infinite alternate;
}

.subtext {
  font-size: 1.3rem;
  font-style: italic;
  color: #ccc;
  margin-bottom: 2rem;
}

@keyframes glow-text {
  from { text-shadow: 0 0 10px #ffec72; }
  to   { text-shadow: 0 0 25px #ffe066; }
}

/* Profile Button */
#profileBtn {
  position: absolute;
  top: 2rem;
  right: 2rem;
  background: linear-gradient(to right, #ffcc00, #ff9900);
  border: none;
  border-radius: 50%;
  width: 58px;
  height: 58px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 0 15px #ffbb00, 0 0 25px #ffcc00;
  cursor: pointer;
  transition: all 0.3s ease;
}

#profileBtn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 20px #fff176, 0 0 35px #ffd54f;
}

#profileBtn i {
  font-size: 26px;
  color: white;
}

/* Buttons */
.action-btn, .logout-btn {
  background: linear-gradient(135deg, #f9d342, #f1c40f);
  color: #111;
  border: none;
  font-weight: bold;
  padding: 0.9rem 1.8rem;
  margin: 0.5rem;
  font-size: 1.1rem;
  border-radius: 50px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  transition: transform 0.2s, box-shadow 0.3s;
}

.action-btn:hover, .logout-btn:hover {
  transform: scale(1.07);
  box-shadow: 0 4px 20px rgba(255, 230, 0, 0.6);
}

/* Worker Cards */
.worker-card {
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(6px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  border-radius: 18px;
  padding: 1.5rem;
  margin: 1rem auto;
  max-width: 420px;
  color: #fff;
  transition: transform 0.3s;
}

.worker-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
}

.worker-info h3 {
  color: #ffd700;
  margin-bottom: 0.2rem;
}

/* Modal */
.modal-content {
  background: #22223b;
  border: 2px solid #ffd70033;
  border-radius: 15px;
  padding: 2rem;
  color: #fff;
  box-shadow: 0 0 15px #ffd70088;
}

.modal-title {
  font-size: 1.8rem;
  color: #ffd700;
}

/* Decorative Jhoomer */
.jhoomer-svg {
  width: 120px;
  margin: 2rem auto;
  animation: swing 4s ease-in-out infinite;
  transform-origin: top center;
}

@keyframes swing {
  0% { transform: rotate(0deg); }
  50% { transform: rotate(4deg); }
  100% { transform: rotate(-4deg); }
}

.footer {
  color: #999;
  font-size: 0.9rem;
  margin-top: 4rem;
}
.post-item {
  padding: 10px;
  border: 1px solid #ddd;
  margin-bottom: 10px;
  border-radius: 5px;
}
.delete-btn {
  background-color: #e74c3c;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
}
.delete-btn:hover {
  background-color: #c0392b;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: rgba(255, 255, 255, 0.06);
  padding: 2rem;
  border-radius: 18px;
  max-width: 600px;
  width: 95%;
  position: relative;
  color: #fff;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.glassy-card {
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.close-btn {
  position: absolute;
  top: 12px; right: 20px;
  font-size: 1.5rem;
  color: #fdd835;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s ease;
}

.close-btn:hover {
  transform: rotate(90deg);
  color: #fff350;
}

.section h3 {
  margin-top: 1.5rem;
  color: #ffd54f;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.empty-message {
  font-style: italic;
  color: #bbb;
  margin-top: 1rem;
}

.post-list {
  margin-top: 0.5rem;
  padding-left: 0.5rem;
}
.action-btn {
  background-color: #fdd835;
  color: #111;
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  margin: 0.5rem;
  transition: 0.3s ease;
}
.action-btn:hover {
  background-color: #ffee58;
  transform: scale(1.05);
}

</style>

</head>
<body>
  <div class="owner-dashboard royal-theme">
    <header>
      <h1>Welcome to Owner Dashboard</h1>
      <p class="subtext">Manage your tenders and find skilled workers</p>
<div id="token-balance" class="text-info" style="font-weight: 600;">Loading Tokens...</div>

      <!-- Profile Button -->
      <button id="profileBtn" title="View Profile & Posts">
        <i class="bi bi-person-circle"></i>
      </button>
  


      <!-- Royal Jhoomer SVG Centered -->
      <div class="jhoomer-svg">
        <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
          <g class="swing">
            <circle cx="50" cy="10" r="4" fill="gold" />
            <line x1="50" y1="10" x2="50" y2="30" stroke="gold" stroke-width="1" />
            <polygon points="40,30 60,30 50,50" fill="gold" />
            <line x1="50" y1="50" x2="45" y2="70" stroke="white" stroke-width="1" />
            <line x1="50" y1="50" x2="55" y2="70" stroke="white" stroke-width="1" />
            <circle cx="45" cy="70" r="2" fill="white" />
            <circle cx="55" cy="70" r="2" fill="white" />
          </g>
        </svg>
      </div>
      <div id="profileModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close-btn">&times;</span>
    <h2 class="modal-title">My Posted Tenders & Auctions</h2>
    <div id="tendersList"></div>
    <div id="auctionsList"></div>
  </div>
</div>

    </header>
    <button class="btn btn-outline-success" onclick="window.location.href='tokens.html'" style="margin-left: 10px;">
  üé´ My Tokens
</button>

<section class="dashboard-actions">
  <!-- Agreement Button -->
<button onclick="window.location.href='promis.html'" class="action-btn" style="background-color: #ffc107; color: #000;">
  <i class="bi bi-file-earmark-text"></i> View Agreement
</button>

  <!-- View Received Applications -->
<button onclick="window.location.href='owner-application.html'" class="action-btn">
  <i class="bi bi-journal-text"></i> Received Applications
</button>
<button onclick="window.location.href='fetch-application.html'" class="action-btn">
  <i class="bi bi-inbox-fill"></i> View Received Applications
</button>

  <!-- Post New Tender -->
  <button onclick="window.location.href='post-tender.html'" class="action-btn">
    <i class="bi bi-file-earmark-plus"></i> Post Tender
  </button>

  <!-- Post New Auction (Boli) -->
  <button onclick="window.location.href='post-auction.html'" class="action-btn">
    <i class="bi bi-megaphone"></i> Post Auction (Boli)
  </button>
<button onclick="window.location.href='owner-posted.html'" class="action-btn">
  üìú View My Tenders
</button>
<!-- How to Use Button -->
<button onclick="window.location.href='how-to-use.html'" class="action-btn">
  <i class="fas fa-question-circle"></i> How to Use
</button>

  <!-- Logout -->
  <button onclick="window.location.href='welcom.html'" class="logout-btn">
    <i class="bi bi-box-arrow-right"></i> Logout
  </button>
</section>

<section class="worker-profiles">
  <h2><i class="bi bi-people"></i> Available Workers</h2>
  <div id="profiles-list" class="scroll-container"></div>
  <div id="no-profiles" class="no-data">No worker profiles available currently.</div>
</section>

<footer class="footer">
  <p>Developed by Prince Sanjay Kumar Rathore &copy; 2025</p>
</footer>
<!-- Include Lottie library in <head> -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<!-- Place this in your dashboard HTML -->
<section class="owner-animation-section">
  <div class="animation-container">
   <lottie-player
  src="https://assets4.lottiefiles.com/packages/lf20_u4yrau.json"
  background="transparent"
  speed="1"
  style="width: 400px; height: 400px;"
  loop
  autoplay>
</lottie-player>

    <h2 class="animation-text">Managing Your Workforce Smartly</h2>
  </div>
</section>


<script>
  function parseJwt(t) {
  try {
    return JSON.parse(atob(t.split('.')[1]));
  } catch (e) {
    console.error("JWT parsing failed:", e);
    return null;
  }
}


  function openApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "block";
    loadApplicationsInModal();
  }

  function closeApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "none";
  }

  window.addEventListener("click", function (event) {
    const modal = document.getElementById("applicationsModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });

  async function loadApplicationsInModal() {
    const token = localStorage.getItem("jwt");
    const container = document.getElementById("applicationsContainer");

    if (!token) {
      container.innerHTML = `<p class="empty-message">Login token missing. Please login again.</p>`;
      return;
    }

    const payload = parseJwt(token);
    const ownerId = payload?.id;

    if (!ownerId) {
      container.innerHTML = `<p class="empty-message">Owner ID not found.</p>`;
      return;
    }

    container.innerHTML = `<p class="empty-message">Loading applications...</p>`;

    try {
      const res = await fetch(`https://llts-app.onrender.com/api/owner/applications/${ownerId}`, {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      const data = await res.json();

      if (data.status === "success" && data.applications.length > 0) {
        container.innerHTML = "";
        data.applications.forEach(app => {
          const div = document.createElement("div");
          div.className = "post-item";
          div.innerHTML = `
            <div><strong>Worker ID:</strong> ${app.worker_id}</div>
            <div><strong>Tender ID:</strong> ${app.tender_id}</div>
            <div><strong>Proposal:</strong> ${app.proposal || "No message"}</div>
            <div><strong>Quoted Price:</strong> ‚Çπ${app.quoted_price || "N/A"}</div>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = `<p class="empty-message">No applications received yet.</p>`;
      }
    } catch (error) {
      console.error("Error loading applications:", error);
      container.innerHTML = `<p class="empty-message">Error fetching applications.</p>`;
    }
  }

  async function loadWorkerProfiles() {
    const list = document.getElementById("profiles-list");
    const noData = document.getElementById("no-profiles");

    try {
      const res = await fetch("https://llts-app.onrender.com/api/worker/all-profiles");

      const profiles = await res.json();

      list.innerHTML = "";
      if (profiles.length > 0) {
        noData.style.display = "none";
        profiles.forEach(profile => {
          const card = document.createElement("div");
          card.className = "worker-card";
          card.innerHTML = `
            <img src="${profile.img}" alt="${profile.name}" class="worker-img" />
            <div class="worker-info">
              <h3>${profile.name}</h3>
              <p><i class="bi ${profile.icon}"></i> ${profile.skill}</p>
              <p>Experience: ${profile.experience}</p>
            </div>
          `;
          list.appendChild(card);
        });
      } else {
        noData.style.display = "block";
      }

    } catch (err) {
      console.error("Error fetching worker profiles:", err);
      noData.style.display = "block";
      noData.innerText = "Unable to load profiles.";
    }
  }

  // Call on load
document.addEventListener("DOMContentLoaded", () => {
  const profileBtn = document.getElementById('profileBtn');
  const profileModal = document.getElementById('profileModal');
  const closeModal = document.getElementById('closeModal');
 function logout() {
    localStorage.clear();
    window.location.href = 'welcom.html';
  }
  if (profileBtn && profileModal && closeModal) {
    profileBtn.addEventListener('click', () => {
      profileModal.style.display = 'block';
      loadUserPosts();
    });

    closeModal.addEventListener('click', () => {
      profileModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target === profileModal) {
        profileModal.style.display = 'none';
      }
    });
  } else {
    console.warn("One or more modal elements missing in DOM");
  }
});

</script>

<!-- üîª POST & AUCTION POSTS -->
<script>
  async function loadUserPosts() {
    const tendersContainer = document.getElementById("tendersList");
    const auctionsContainer = document.getElementById("auctionsList");
    tendersContainer.innerHTML = `<p class="empty-message">Loading tenders...</p>`;
    auctionsContainer.innerHTML = `<p class="empty-message">Loading auctions...</p>`;

    const token = localStorage.getItem("jwt");

    try {
      const tenderRes = await fetch("https://llts-app.onrender.com/api/owner/tenders", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const tenderData = await tenderRes.json();

      if (tenderData.length > 0) {
        tendersContainer.innerHTML = "";
        tenderData.forEach(tender => {
          const div = document.createElement("div");
          div.className = "post-item";
          div.innerHTML = `
            <div class="post-type">Tender: ${tender.category}</div>
            <div><strong>Work:</strong> ${tender.description}</div>
            <div><strong>Price:</strong> ‚Çπ${tender.budget}</div>
            <div><strong>Location:</strong> ${tender.location}</div>`;
          tendersContainer.appendChild(div);
        });
      } else {
        tendersContainer.innerHTML = `<p class="empty-message">No tenders posted yet.</p>`;
      }

      const auctionRes = await fetch("https://llts-app.onrender.com/api/owner/auctions", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const auctionData = await auctionRes.json();

      if (auctionData.length > 0) {
        auctionsContainer.innerHTML = "";
        auctionData.forEach(auction => {
          const div = document.createElement("div");
          div.className = "post-item";
          div.innerHTML = `
            <div class="post-type">Auction: ${auction.category}</div>
            <div><strong>Details:</strong> ${auction.description}</div>
            <div><strong>Start Price:</strong> ‚Çπ${auction.starting_price}</div>
            <div><strong>Location:</strong> ${auction.location}</div>`;
          auctionsContainer.appendChild(div);
        });
      } else {
        auctionsContainer.innerHTML = `<p class="empty-message">No auctions posted yet.</p>`;
      }

    } catch (err) {
      console.error("Error loading posts:", err);
      tendersContainer.innerHTML = `<p class="empty-message">Failed to load tenders.</p>`;
      auctionsContainer.innerHTML = `<p class="empty-message">Failed to load auctions.</p>`;
    }
  }
</script>
<!-- üîª APPLICATION MODAL -->
<div id="applicationsModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeApplicationsModal()">&times;</span>
    <h2 class="modal-title">Received Applications</h2>
    <div id="applicationsContainer">
      <p class="empty-message">Loading applications...</p>
    </div>
  </div>
</div>

<!-- üîª APPLICATION LOADER -->
<script>

  function openApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "block";
    loadApplicationsInModal();
  }

  function closeApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "none";
  }

  window.addEventListener("click", function (event) {
    const modal = document.getElementById("applicationsModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });

async function loadApplicationsInModal() {
  const token = localStorage.getItem("jwt");
  const container = document.getElementById("applicationsContainer");

  // üßæ Step 1: Check if token exists
  if (!token) {
    container.innerHTML = `<p class="empty-message">Login token missing. Please login again.</p>`;
    return;
  }

  // üîê Step 2: Parse JWT safely
  let ownerId;
  try {
    const payload = parseJwt(token);
    if (!payload || !payload.id) throw new Error("Invalid token payload");
    ownerId = payload.id;
  } catch (e) {
    console.error("JWT parsing failed:", e);
    container.innerHTML = `<p class="empty-message">Invalid or expired token. Please login again.</p>`;
    return;
  }

  // ‚è≥ Step 3: Show loading message
  container.innerHTML = `<p class="empty-message">Loading applications...</p>`;

  // üì° Step 4: Fetch applications from backend
  try {
    const res = await fetch(`https://llts-app.onrender.com/api/owner/applications/${ownerId}`, {

      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    if (!res.ok) {
      throw new Error(`Server error: ${res.status}`);
    }

    const data = await res.json();

    // üì¶ Step 5: Display application data
    if (data.status === "success" && Array.isArray(data.applications) && data.applications.length > 0) {
      container.innerHTML = "";
      data.applications.forEach(app => {
        const div = document.createElement("div");
        div.className = "post-item";
        div.innerHTML = `
          <div><strong>Worker ID:</strong> ${app.worker_id}</div>
          <div><strong>Tender ID:</strong> ${app.tender_id}</div>
          <div><strong>Proposal:</strong> ${app.proposal || "No message"}</div>
          <div><strong>Quoted Price:</strong> ‚Çπ${app.quoted_price || "N/A"}</div>
        `;
        container.appendChild(div);
      });
    } else {
      container.innerHTML = `<p class="empty-message">No applications received yet.</p>`;
    }

  } catch (error) {
    console.error("Error loading applications:", error);
    container.innerHTML = `<p class="empty-message">Error fetching applications. Please try again later.</p>`;
  }
}
async function loadPostedTenders() {
  const token = localStorage.getItem("jwt");  // ‚úÖ Use correct key
  const list = document.getElementById("tendersList");
  list.innerHTML = "<p>Loading...</p>";

  try {
    const res = await fetch("https://llts-app.onrender.com/api/owner/tenders", {  // ‚úÖ Fixed URL
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();
    if (!res.ok || !Array.isArray(data.tenders)) {
      list.innerHTML = "<p>Failed to load tenders.</p>";
      return;
    }

    if (data.tenders.length === 0) {
      list.innerHTML = "<p class='text-muted'>No tenders posted yet.</p>";
      return;
    }

    list.innerHTML = '';
    for (const tender of data.tenders) {
      const item = document.createElement('div');
      item.className = 'post-item';

      item.innerHTML = `
        <h4>${tender.title}</h4>
        <p><strong>Category:</strong> ${tender.category}</p>
        <p><strong>Location:</strong> ${tender.location}</p>
        <p><strong>Deadline:</strong> ${new Date(tender.deadline).toLocaleDateString()}</p>
        <p><strong>Applications:</strong> ${tender.applications || 0}</p>
        <button class="delete-btn" onclick="deleteTender('${tender._id}')">‚ùå Delete</button>
        <hr/>
      `;

      list.appendChild(item);
    }

  } catch (err) {
    console.error("Error loading tenders:", err);
    list.innerHTML = "<p>Error loading tenders.</p>";
  }
}

async function deleteTender(tenderId) {
  const token = localStorage.getItem("jwt");  // ‚úÖ Fix here
  if (!confirm("Are you sure you want to delete this tender?")) return;

  try {
    const res = await fetch(`https://llts-app.onrender.com/api/owner/delete-tender/${tenderId}`, {  // ‚úÖ Use deployed URL
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();
    if (res.ok) {
      alert("Tender deleted successfully.");
      loadPostedTenders(); // Reload after delete
    } else {
      alert("Failed to delete tender.");
      console.error(data);
    }
  } catch (err) {
    console.error("Delete error:", err);
    alert("Error deleting tender.");
  }
}


// Load on modal open
document.getElementById("profileBtn").addEventListener("click", () => {
  loadPostedTenders();
});
