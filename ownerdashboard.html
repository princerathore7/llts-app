<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Owner Dashboard</title>

  <!-- ‚úÖ AdSense Meta + Script -->
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

  <meta name="google-adsense-account" content="ca-pub-7342369119079593">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7342369119079593" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="lltsstyle.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<style>
  body {
  background: #12151f;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  color: #f0f2f5;
}

.owner-dashboard {
  max-width: 1200px;
  margin: auto;
  padding: 2rem 1rem;
}

header h1 {
  font-size: 2.6rem;
  color: #3d8bfd;
  text-align: center;
  margin-bottom: 10px;
}

.subtext {
  text-align: center;
  color: #aab1c2;
  font-size: 1.1rem;
  margin-bottom: 2rem;
}

#profileBtn {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #1e2230;
  border: 1px solid #3d8bfd;
  border-radius: 50%;
  width: 52px;
  height: 52px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 20px;
  color: #3d8bfd;
  box-shadow: 0 0 10px rgba(61, 139, 253, 0.3);
  cursor: pointer;
  transition: 0.3s ease;
  z-index: 1000;
}

#profileBtn:hover {
  background-color: #2a2f45;
}

.action-btn, .logout-btn {
  background: linear-gradient(to right, #3d8bfd, #5b73f1);
  border: none;
  color: #fff;
  font-weight: 500;
  padding: 12px 22px;
  margin: 0.5rem;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s ease;
}

.action-btn:hover, .logout-btn:hover {
  opacity: 0.9;
}

.worker-card {
  background: #1e2230;
  border: 1px solid #2c3245;
  border-radius: 10px;
  padding: 1.2rem 1.5rem;
  margin: 1.2rem auto;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  max-width: 420px;
  transition: transform 0.3s;
}

.worker-card:hover {
  transform: translateY(-4px);
}

.worker-info h3 {
  color: #3d8bfd;
  margin-bottom: 0.5rem;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(3px);
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: #1e2230;
  padding: 2rem;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  color: #f0f2f5;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
  position: relative;
}

.modal-title {
  font-size: 1.6rem;
  color: #5b73f1;
  margin-bottom: 1.2rem;
}

.close-btn {
  position: absolute;
  top: 12px;
  right: 20px;
  font-size: 1.4rem;
  color: #999;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
}

.close-btn:hover {
  color: #fff;
}

.post-item {
  background: #2c3245;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
  border: 1px solid #444c60;
  color: #eee;
}

.delete-btn {
  background-color: #e74c3c;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.delete-btn:hover {
  background-color: #c0392b;
}

.token-button {
  background-color: #5b73f1;
  border: none;
  padding: 10px 20px;
  color: #fff;
  font-weight: 600;
  border-radius: 6px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.token-button:hover {
  background-color: #3d8bfd;
}

.footer {
  color: #999;
  font-size: 0.85rem;
  text-align: center;
  margin-top: 3rem;
}

@media (max-width: 768px) {
  header h1 {
    font-size: 2rem;
  }

  .subtext {
    font-size: 1rem;
  }

  .action-btn, .logout-btn {
    font-size: 0.95rem;
    padding: 10px 18px;
  }

  .worker-card {
    width: 92%;
  }

  .modal-content {
    width: 95%;
    padding: 1.5rem;
  }
}


</style>
</head>

</head>
<body>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7342369119079593"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-7342369119079593"
     data-ad-slot="4926113294"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
  <div class="owner-dashboard royal-theme">
    <header>
      <h1>Welcome to Owner Dashboard</h1>
      <p class="subtext">Manage your tenders and find skilled workers</p>
<div id="token-balance" class="text-info" style="font-weight: 600;">LLTS corporations </div>

      <!-- Profile Button -->
  <button id="profileBtn" title="View Profile">
  <i class="bi bi-person-circle"></i>
</button>

 <div class="footer-links">
    <a href="about.html">About</a> ‚Ä¢
    <a href="privacy.html">Privacy</a> ‚Ä¢
    <a href="terms.html">Terms</a> ‚Ä¢
    <a href="disclaimer.html">Disclaimer</a> ‚Ä¢
    <a href="contact.html">Contact</a>
  </div>


      <!-- Royal Jhoomer SVG Centered -->
      <div class="jhoomer-svg">
        <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
          <g class="swing">
            <circle cx="50" cy="10" r="4" fill="gold" />
            <line x1="50" y1="10" x2="50" y2="30" stroke="gold" stroke-width="1" />
            <polygon points="40,30 60,30 50,50" fill="gold" />
            <line x1="50" y1="50" x2="45" y2="70" stroke="white" stroke-width="1" />
            <line x1="50" y1="50" x2="55" y2="70" stroke="white" stroke-width="1" />
            <circle cx="45" cy="70" r="2" fill="white" />
            <circle cx="55" cy="70" r="2" fill="white" />
          </g>
        </svg>
      </div>
      <div id="profileModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close-btn">&times;</span>
    <h2 class="modal-title">My Posted Tenders & Auctions</h2>
    <div id="tendersList"></div>
    <div id="auctionsList"></div>
  </div>
</div>
  </style>
</head>
<body>
  <header>
    <h1>üìú LLTS Tenders & Auctions</h1>
  </header>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7342369119079593"
     crossorigin="anonymous"></script>
<!-- ad unit for llts -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-7342369119079593"
     data-ad-slot="2977325547"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 2rem;">
    <button onclick="window.location.href='worker-dashboard.html'" style="background-color: crimson; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: bold; cursor: pointer;">
      ‚úñ Close
    </button>

    <button onclick="fetchTendersAndAuctions()" style="background-color: #fdd835; color: #000; border: none; padding: 8px 14px; border-radius: 6px; font-weight: bold; cursor: pointer;">
      üîÅ Refresh
    </button>
  </div>

    </header>
    <button class="btn btn-outline-success" onclick="window.location.href='tokens.html'" style="margin-left: 10px;">
  üé´ My Tokens
</button>

<section class="dashboard-actions">
  <!-- Agreement Button -->
<button onclick="window.location.href='promis.html'" class="action-btn" style="background-color: #ffc107; color: #000;">
  <i class="bi bi-file-earmark-text"></i> View Agreement
</button>

  <!-- View Received Applications -->
<button onclick="window.location.href='owner-application.html'" class="action-btn">
  <i class="bi bi-journal-text"></i> Received Applications
</button>

<button id="watchAdBtnOwner" class="token-button">
  üéÅ Watch Ad & Get 1 Token
</button>

  <!-- Post New Tender -->
  <button onclick="window.location.href='post-tender.html'" class="action-btn">
    <i class="bi bi-file-earmark-plus"></i> Post Tender
  </button>

  <!-- Post New Auction (Boli) -->
  <!-- <button onclick="window.location.href='post-auction.html'" class="action-btn">
    <i class="bi bi-megaphone"></i> Post Auction (Boli)
  </button> -->
<button onclick="window.location.href='owner-posted.html'" class="action-btn">
  üìú View My Tenders
</button>
<!-- How to Use Button -->
<button onclick="window.location.href='how-to-use.html'" class="action-btn">
  <i class="fas fa-question-circle"></i> How to Use
</button>

  <!-- Logout -->
  <button onclick="window.location.href='welcom.html'" class="logout-btn">
    <i class="bi bi-box-arrow-right"></i> Logout
  </button>
</section>

<section class="worker-profiles">
  <h2><i class="bi bi-people"></i> Available Workers</h2>
  <div id="profiles-list" class="scroll-container"></div>
  <div id="no-profiles" class="no-data"></div>
</section>

<footer class="footer">
  <p>Developed by Prince Sanjay Kumar Rathore &copy; 2025</p>
</footer>
<!-- Include Lottie library in <head> -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<!-- Place this in your dashboard HTML -->
<section class="owner-animation-section">
  <div class="animation-container">
   <lottie-player
  src="https://assets4.lottiefiles.com/packages/lf20_u4yrau.json"
  background="transparent"
  speed="1"
  style="width: 400px; height: 400px;"
  loop
  autoplay>
</lottie-player>

    <h2 class="animation-text">Managing Your Workforce Smartly</h2>
  </div>
</section>


<script>
  
  // ‚úÖ JWT Parser
  function parseJwt(token) {
    try {
      return JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
      console.error("JWT parsing failed:", e);
      return null;
    }
  }

  // ‚úÖ Application Modal Controls
  function openApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "block";
    loadApplicationsInModal();
  }

  function closeApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "none";
  }

  window.addEventListener("click", function (event) {
    const modal = document.getElementById("applicationsModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });

  // ‚úÖ Load Applications in Modal
  async function loadApplicationsInModal() {
    const token = localStorage.getItem("jwt");
    const container = document.getElementById("applicationsContainer");

    if (!token) {
      container.innerHTML = `<p class="empty-message">Login token missing. Please login again.</p>`;
      return;
    }

    const payload = parseJwt(token);
    const ownerId = payload?.id;
    if (!ownerId) {
      container.innerHTML = `<p class="empty-message">Owner ID not found.</p>`;
      return;
    }

    container.innerHTML = `<p class="empty-message">Loading applications...</p>`;

    try {
      const res = await fetch(`https://llts-app.onrender.com/api/owner/applications/${ownerId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      const data = await res.json();
      console.log("üì• Applications response:", data);

      if (Array.isArray(data.applications) && data.applications.length > 0) {
        container.innerHTML = "";
        data.applications.forEach(app => {
          const div = document.createElement("div");
          div.className = "post-item";
          div.innerHTML = `
            <div><strong>Worker ID:</strong> ${app.worker_id}</div>
            <div><strong>Tender ID:</strong> ${app.tender_id}</div>
            <div><strong>Proposal:</strong> ${app.proposal || "No message"}</div>
            <div><strong>Quoted Price:</strong> ‚Çπ${app.quoted_price || "N/A"}</div>
          `;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = `<p class="empty-message">No applications received yet.</p>`;
      }
    } catch (error) {
      console.error("‚ùå Error loading applications:", error);
      container.innerHTML = `<p class="empty-message">Error fetching applications.</p>`;
    }
  }

  // ‚úÖ Load Worker Profiles
  async function loadWorkerProfiles() {
    const list = document.getElementById("profiles-list");
    const noData = document.getElementById("no-profiles");
    const token = localStorage.getItem("jwt"); // ‚úÖ Use correct key

    try {
      const res = await fetch("https://llts-app.onrender.com/api/worker/all-profiles", {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      const profiles = await res.json();
      console.log("üì¶ Worker profiles:", profiles);

      list.innerHTML = "";
      if (Array.isArray(profiles) && profiles.length > 0) {
        noData.style.display = "none";
        profiles.forEach(profile => {
          const card = document.createElement("div");
          card.className = "worker-card";
          card.innerHTML = `
            <img src="${profile.img}" alt="${profile.name}" class="worker-img" />
            <div class="worker-info">
              <h3>${profile.name}</h3>
              <p><i class="bi ${profile.icon}"></i> ${profile.skill}</p>
              <p>Experience: ${profile.experience}</p>
            </div>
          `;
          list.appendChild(card);
        });
      } else {
        noData.style.display = "block";
        noData.innerText = "No profiles found.";
      }

    } catch (err) {
      console.error("‚ùå Error fetching worker profiles:", err);
      noData.style.display = "block";
      noData.innerText = "Unable to load profiles.";
    }
  }



  // Call on load
document.addEventListener("DOMContentLoaded", () => {
  const profileBtn = document.getElementById('profileBtn');
  const profileModal = document.getElementById('profileModal');
  const closeModal = document.getElementById('closeModal');
 function logout() {
    localStorage.clear();
    window.location.href = 'welcom.html';
  }
  if (profileBtn && profileModal && closeModal) {
    profileBtn.addEventListener('click', () => {
      profileModal.style.display = 'block';
      loadUserPosts();
    });

    closeModal.addEventListener('click', () => {
      profileModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target === profileModal) {
        profileModal.style.display = 'none';
      }
    });
  } else {
    console.warn("One or more modal elements missing in DOM");
  }
});

</script>

<!-- üîª POST & AUCTION POSTS -->
<script>
  async function loadUserPosts() {
    const tendersContainer = document.getElementById("tendersList");
    const auctionsContainer = document.getElementById("auctionsList");
    tendersContainer.innerHTML = `<p class="empty-message">Loading tenders...</p>`;
    auctionsContainer.innerHTML = `<p class="empty-message">Loading auctions...</p>`;

    const token = localStorage.getItem("jwt");

    try {
      const tenderRes = await fetch("https://llts-app.onrender.com/api/owner/tenders", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const tenderData = await tenderRes.json();

      if (tenderData.length > 0) {
        tendersContainer.innerHTML = "";
        tenderData.forEach(tender => {
          const div = document.createElement("div");
          div.className = "post-item";
          div.innerHTML = `
            <div class="post-type">Tender: ${tender.category}</div>
            <div><strong>Work:</strong> ${tender.description}</div>
            <div><strong>Price:</strong> ‚Çπ${tender.budget}</div>
            <div><strong>Location:</strong> ${tender.location}</div>`;
          tendersContainer.appendChild(div);
        });
      } else {
        tendersContainer.innerHTML = `<p class="empty-message">No tenders posted yet.</p>`;
      }

      const auctionRes = await fetch("https://llts-app.onrender.com/api/owner/auctions", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const auctionData = await auctionRes.json();

      if (auctionData.length > 0) {
        auctionsContainer.innerHTML = "";
        auctionData.forEach(auction => {
          const div = document.createElement("div");
          div.className = "post-item";
          div.innerHTML = `
            <div class="post-type">Auction: ${auction.category}</div>
            <div><strong>Details:</strong> ${auction.description}</div>
            <div><strong>Start Price:</strong> ‚Çπ${auction.starting_price}</div>
            <div><strong>Location:</strong> ${auction.location}</div>`;
          auctionsContainer.appendChild(div);
        });
      } else {
        auctionsContainer.innerHTML = `<p class="empty-message">No auctions posted yet.</p>`;
      }

    } catch (err) {
      console.error("Error loading posts:", err);
      tendersContainer.innerHTML = `<p class="empty-message">Failed to load tenders.</p>`;
      auctionsContainer.innerHTML = `<p class="empty-message">Failed to load auctions.</p>`;
    }
  }
</script>
<!-- üîª APPLICATION MODAL -->
<div id="applicationsModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeApplicationsModal()">&times;</span>
    <h2 class="modal-title">Received Applications</h2>
    <div id="applicationsContainer">
      <p class="empty-message">Loading applications...</p>
    </div>
  </div>
</div>

<!-- üîª APPLICATION LOADER -->
<script>

  function openApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "block";
    loadApplicationsInModal();
  }

  function closeApplicationsModal() {
    document.getElementById("applicationsModal").style.display = "none";
  }

  window.addEventListener("click", function (event) {
    const modal = document.getElementById("applicationsModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });

async function loadApplicationsInModal() {
  const token = localStorage.getItem("jwt");
  const container = document.getElementById("applicationsContainer");

  // üßæ Step 1: Check if token exists
  if (!token) {
    container.innerHTML = `<p class="empty-message">Login token missing. Please login again.</p>`;
    return;
  }

  // üîê Step 2: Parse JWT safely
  let ownerId;
  try {
    const payload = parseJwt(token);
    if (!payload || !payload.id) throw new Error("Invalid token payload");
    ownerId = payload.id;
  } catch (e) {
    console.error("JWT parsing failed:", e);
    container.innerHTML = `<p class="empty-message">Invalid or expired token. Please login again.</p>`;
    return;
  }

  // ‚è≥ Step 3: Show loading message
  container.innerHTML = `<p class="empty-message">Loading applications...</p>`;

  // üì° Step 4: Fetch applications from backend
  try {
    const res = await fetch(`https://llts-app.onrender.com/api/owner/applications/${ownerId}`, {

      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    if (!res.ok) {
      throw new Error(`Server error: ${res.status}`);
    }

    const data = await res.json();

    // üì¶ Step 5: Display application data
    if (data.status === "success" && Array.isArray(data.applications) && data.applications.length > 0) {
      container.innerHTML = "";
      data.applications.forEach(app => {
        const div = document.createElement("div");
        div.className = "post-item";
        div.innerHTML = `
          <div><strong>Worker ID:</strong> ${app.worker_id}</div>
          <div><strong>Tender ID:</strong> ${app.tender_id}</div>
          <div><strong>Proposal:</strong> ${app.proposal || "No message"}</div>
          <div><strong>Quoted Price:</strong> ‚Çπ${app.quoted_price || "N/A"}</div>
        `;
        container.appendChild(div);
      });
    } else {
      container.innerHTML = `<p class="empty-message">No applications received yet.</p>`;
    }

  } catch (error) {
    console.error("Error loading applications:", error);
    container.innerHTML = `<p class="empty-message">Error fetching applications. Please try again later.</p>`;
  }
}
async function loadPostedTenders() {
  const token = localStorage.getItem("jwt");  // ‚úÖ Use correct key
  const list = document.getElementById("tendersList");
  list.innerHTML = "<p>Loading...</p>";

  try {
    const res = await fetch("https://llts-app.onrender.com/api/owner/tenders", {  // ‚úÖ Fixed URL
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();
    if (!res.ok || !Array.isArray(data.tenders)) {
      list.innerHTML = "<p>Failed to load tenders.</p>";
      return;
    }

    if (data.tenders.length === 0) {
      list.innerHTML = "<p class='text-muted'>No tenders posted yet.</p>";
      return;
    }

    list.innerHTML = '';
    for (const tender of data.tenders) {
      const item = document.createElement('div');
      item.className = 'post-item';

      item.innerHTML = `
        <h4>${tender.title}</h4>
        <p><strong>Category:</strong> ${tender.category}</p>
        <p><strong>Location:</strong> ${tender.location}</p>
        <p><strong>Deadline:</strong> ${new Date(tender.deadline).toLocaleDateString()}</p>
        <p><strong>Applications:</strong> ${tender.applications || 0}</p>
        <button class="delete-btn" onclick="deleteTender('${tender._id}')">‚ùå Delete</button>
        <hr/>
      `;

      list.appendChild(item);
    }

  } catch (err) {
    console.error("Error loading tenders:", err);
    list.innerHTML = "<p>Error loading tenders.</p>";
  }
}

async function deleteTender(tenderId) {
  const token = localStorage.getItem("jwt");  // ‚úÖ Fix here
  if (!confirm("Are you sure you want to delete this tender?")) return;

  try {
    const res = await fetch(`https://llts-app.onrender.com/api/owner/delete-tender/${tenderId}`, {  // ‚úÖ Use deployed URL
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();
    if (res.ok) {
      alert("Tender deleted successfully.");
      loadPostedTenders(); // Reload after delete
    } else {
      alert("Failed to delete tender.");
      console.error(data);
    }
  } catch (err) {
    console.error("Delete error:", err);
    alert("Error deleting tender.");
  }
}


// Load on modal open
document.getElementById("profileBtn").addEventListener("click", () => {
  loadPostedTenders();
});
async function loadAvailableWorkers() {
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const res = await fetch("https://llts-app.onrender.com/api/owner/available-workers", {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();
    const workers = data.workers || [];

    const container = document.getElementById("profiles-list");
    const emptyMsg = document.getElementById("no-profiles");

    container.innerHTML = "";
    emptyMsg.innerHTML = "";

    if (workers.length === 0) {
      emptyMsg.innerText = "No workers found.";
      return;
    }

    workers.forEach(w => {
      container.innerHTML += `
        <div class="worker-card">
          <h3>${w.name}</h3>
          <p><strong>Category:</strong> ${w.category || "N/A"}</p>
          <p><strong>Location:</strong> ${w.location || "N/A"}</p>
          <p><strong>Contact:</strong> ${w.contact || "N/A"}</p>
        </div>
      `;
    });

  } catch (err) {
    console.error("‚ùå Error loading workers:", err);
  }
}

document.addEventListener("DOMContentLoaded", loadAvailableWorkers);

  document.getElementById("profileBtn").addEventListener("click", function () {
    window.location.href = "owner-profile.html";
  });
</script>
